# Preview and Deployment API Documentation

## Overview

The Preview and Deployment API provides endpoints for creating, managing, and interacting with preview environments for generated applications. This allows users to view and test their generated applications directly within the platform.

## Base URL

```
/api/v1/projects/:projectId/builds/:buildId
```

## Authentication

All endpoints require JWT authentication. Include the JWT token in the Authorization header:

```
Authorization: Bearer <jwt_token>
```

## Endpoints

### 1. Get Preview Environment

Get the current preview environment status for a build.

**Endpoint:** `GET /preview`

**Parameters:**
- `projectId` (path) - The project ID
- `buildId` (path) - The build request ID

**Response:**

```json
{
  "data": {
    "id": "preview-abc123",
    "buildRequestId": "abc123",
    "projectId": "proj456",
    "status": "running",
    "url": "/api/v1/projects/proj456/builds/abc123/artifacts",
    "containerName": null,
    "port": null,
    "createdAt": "2024-01-15T10:30:00Z",
    "startedAt": "2024-01-15T10:30:05Z",
    "stoppedAt": null,
    "error": null
  }
}
```

**Status Codes:**
- `200 OK` - Preview environment found
- `404 Not Found` - No preview environment exists for this build
- `401 Unauthorized` - Invalid or missing authentication token

**Status Values:**
- `pending` - Preview is being created
- `building` - Preview is being built
- `running` - Preview is active and accessible
- `stopped` - Preview has been stopped
- `failed` - Preview creation or deployment failed

---

### 2. Create Preview Environment

Create a new preview environment for a completed build.

**Endpoint:** `POST /preview`

**Parameters:**
- `projectId` (path) - The project ID
- `buildId` (path) - The build request ID

**Request Body:** None

**Response:**

```json
{
  "data": {
    "id": "preview-abc123",
    "buildRequestId": "abc123",
    "projectId": "proj456",
    "status": "building",
    "createdAt": "2024-01-15T10:30:00Z"
  }
}
```

**Status Codes:**
- `201 Created` - Preview environment created successfully
- `400 Bad Request` - Build artifacts not found or build not completed
- `401 Unauthorized` - Invalid or missing authentication token

**Notes:**
- Build must be in `completed` status
- Preview can only be created once per build
- Subsequent calls will return the existing preview status

---

### 3. Get Build Artifacts

List all artifacts generated by a build.

**Endpoint:** `GET /artifacts`

**Parameters:**
- `projectId` (path) - The project ID
- `buildId` (path) - The build request ID

**Response:**

```json
{
  "data": {
    "buildId": "abc123",
    "count": 15,
    "artifacts": [
      {
        "name": "package.json",
        "path": "package.json",
        "type": "json"
      },
      {
        "name": "index.ts",
        "path": "src/index.ts",
        "type": "typescript"
      },
      {
        "name": "README.md",
        "path": "README.md",
        "type": "markdown"
      }
    ]
  }
}
```

**Artifact Types:**
- `typescript` - TypeScript source files (.ts, .tsx)
- `javascript` - JavaScript source files (.js, .jsx)
- `json` - JSON configuration files
- `markdown` - Documentation files (.md)
- `yaml` - YAML configuration files (.yml, .yaml)
- `stylesheet` - CSS files
- `html` - HTML files
- `file` - Other file types

**Status Codes:**
- `200 OK` - Artifacts retrieved successfully
- `401 Unauthorized` - Invalid or missing authentication token
- `404 Not Found` - Build not found

**Notes:**
- Returns empty array if build has no artifacts
- Artifacts are scanned recursively up to 3 levels deep
- Excludes `node_modules` and hidden directories

---

### 4. Stop Preview Environment

Stop a running preview environment.

**Endpoint:** `DELETE /preview/:previewId`

**Parameters:**
- `projectId` (path) - The project ID
- `buildId` (path) - The build request ID
- `previewId` (path) - The preview environment ID

**Response:**
- `204 No Content` - Preview stopped successfully

**Status Codes:**
- `204 No Content` - Preview stopped successfully
- `401 Unauthorized` - Invalid or missing authentication token

**Notes:**
- Currently a no-op in the basic implementation
- In a full implementation, this would stop Docker containers

---

## Implementation Details

### Current Implementation

The current implementation provides a foundation for preview functionality:

1. **Artifact Scanning**: Scans the build directory for generated files
2. **Status Tracking**: Tracks preview environment lifecycle
3. **URL Generation**: Generates artifact viewing URLs

### Future Enhancements

For production deployment, the following enhancements are planned:

1. **Docker Integration**:
   - Containerize generated applications
   - Dynamic port allocation
   - Container lifecycle management
   - Resource limits and monitoring

2. **Live Preview**:
   - Embedded iframe preview
   - Interactive application testing
   - Real-time updates
   - Data seeding and reset

3. **Custom Domains**:
   - Subdomain allocation per preview
   - SSL/TLS certificate management
   - Custom domain mapping

4. **Deployment Options**:
   - One-click deployment to staging/production
   - Integration with cloud providers (AWS, GCP, Azure)
   - CI/CD pipeline integration
   - Rollback capabilities

---

## Example Usage

### Creating and Accessing a Preview

```typescript
// 1. Create a preview after build completes
const response = await fetch(
  '/api/v1/projects/proj123/builds/build456/preview',
  {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    }
  }
);

const { data: preview } = await response.json();
console.log('Preview created:', preview.id);
console.log('Status:', preview.status);

// 2. Poll for preview status
const checkPreview = async () => {
  const response = await fetch(
    '/api/v1/projects/proj123/builds/build456/preview',
    {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    }
  );
  
  const { data: preview } = await response.json();
  
  if (preview.status === 'running') {
    console.log('Preview is ready!');
    console.log('URL:', preview.url);
  } else if (preview.status === 'failed') {
    console.error('Preview failed:', preview.error);
  }
  
  return preview;
};

// 3. Get artifacts
const artifactsResponse = await fetch(
  '/api/v1/projects/proj123/builds/build456/artifacts',
  {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  }
);

const { data: artifactData } = await artifactsResponse.json();
console.log(`Found ${artifactData.count} artifacts`);
artifactData.artifacts.forEach(artifact => {
  console.log(`${artifact.type}: ${artifact.path}`);
});
```

---

## Error Handling

All endpoints follow standard HTTP status codes and return errors in the following format:

```json
{
  "statusCode": 400,
  "error": "Bad Request",
  "message": "Build artifacts not found"
}
```

Common error scenarios:

1. **Build not completed**: Cannot create preview for pending/running builds
2. **Artifacts not found**: Build completed but no artifacts were generated
3. **Preview already exists**: Attempting to create duplicate preview
4. **Unauthorized**: Missing or invalid JWT token

---

## Security Considerations

1. **User Isolation**: Previews are isolated per user account
2. **Path Traversal Prevention**: Artifact paths are sanitized
3. **Resource Limits**: Future implementation will include CPU/memory limits
4. **Access Control**: Only the build owner can create/access previews

---

## Performance Notes

1. **Artifact Scanning**: Limited to 3 directory levels for performance
2. **Polling**: Clients should poll preview status every 3-5 seconds
3. **Caching**: Future implementation will cache artifact lists
4. **Cleanup**: Stopped previews should be cleaned up after 24 hours (planned)

---

## Changelog

### Version 1.0.0 (Current)
- Initial preview and artifacts API
- Basic file scanning and artifact listing
- Status tracking and URL generation
- Foundation for Docker integration

### Planned for Version 1.1.0
- Docker container deployment
- Live preview iframe integration
- Port management and routing
- Resource monitoring

### Planned for Version 1.2.0
- Custom domain support
- One-click deployment
- Deployment history
- Rollback functionality
